В old.rueo.ru лежит код функционирующего сайта больших словарей эсперанто. Он был создан больше 20 лет назад и изрядно устарел. Пользователям не хватает многих функций, одним из важных запросов является полнотекстовый поиск по базе.
Исходные файлы существуют в виде текстовых файлов в кодировке Windows-1251 с разметкой, которую мы придумали, приступая к набору огромного рукописного текста этого словаря. Работа над словарём продолжается, примерно раз в шесть дней мы обновляем базу, загружая на сайт полный комплект исходных файлов для эсперанто-русской и русско-эсперантской частей словаря. За построение базы данных (сейчас это MariaDB) отвечает PHP-скрипт, который запускается Python-сервером отдельно для каждого файла (скрипт, кажется, мог бы работать и на полном объёме исходных файлов, но вылетал по тайм-ауту, поэтому придумана такая схема. Код Python-сервера лежит в References/base_update, сам скрипт - References/base_update/updater_src/vortaro_updater_8.php.
В базу данных исходные тексты попадают практически неизменными, разбиваясь на отдельные записи - по одной словарной статье на запись. Отдельно во время парсинга строятся поисковые индексы, по которым на сайте работает AJAX-поиск и выдача найденной статьи. Визуальный рендеринг в html выполняет в основном страница sercxo.php.
Команда разработчиков, несколько лет назад подключившаяся к нашему проекту, сделала "фронтенд" на Vue+Quasar, код в актуальном состоянии лежит в rueo_fronto. Однако пока этот "фронтенд" работает как роутер, отправляя запросы к old.rueo.ru и выводит результат. Тем не менее, он очень помог нам, потому что сборка кода в режиме pwa позволяет установить его как мобильное приложение. Но всё же хочется реализовать полноценную архитектуру бэкенда.
Мы с тобой начали работу над бэкендом, определившись с тем, что это будет код на Python с хранением данных в виде JSON. (папка References/new.rueo.ru.) Начали создавать парсер, но практически упёрлись в то, что синтаксис статей чересчур сложный и во многих местах неоднозначный, поэтому в любом случае для каких-то статей понадобится вмешательство человека для полного семантического разбора на составные части (слово, перевод, пример, иллюстрация, пояснение, примечание и т. п.) Работали над ним в диалоговом режиме: я просматривал сгенерированный JSON, начиная с первых статей буквы A, сообщал тебе замеченные проблемы, ты дорабатывал скрипты, мы снова парсили файл, я смотрел, что изменилось... Попытки работать поиском-заменой по регулярным выражениям очень быстро доказали полную безрезультатность: исправляя что-то одно, мы ломали уже сделанное ранее. Решили работать, создавая шаблоны на статьи с разной степенью сложности и разным устройством. Эта работа пошла более успешно, но тоже почти остановилась, потому что визуально воспринимать JSON мне очень сложно. В папке этого проекта есть файлы памяти проекта, там всё должно быть подробно расписано.
Параллельно мы решали ещё одну проблему. В настоящее время автор работает над русско-эсперантским словарём. В тот момент, когда была завершена основная работа над эсперанто-русским, мы сделали автоматическую инверсию текста, так что русские переводы в эсперанто-русском словаре стали ключевыми словами статей, а эсперантские слова - их переводами. Получился достаточно грязный черновик, автор идёт по нему последовательно и формирует уже полноценные словарные статьи.
В заголовке каждой словарной статьи стоят служебные строки с датой и исполнителем. Их может быть несколько, тогда актуальной является последняя, с самой свежей датой. Дата последнего редактирования статьи визуализируется в интерфейсе словаря, помогая понять, когда вносились изменения.
Так вот, автор ленится, редактируя статьи, поэтому далеко не всегда обновляет эту дату. Мы сделали скрипт (References/updater.rueo.ru), который запоминает состояние каждой статьи в виде контрольной суммы (с какими-то оговорками - некоторые изменения в тексте мы договорились игнорировать) и, когда он запускается на обновлённом наборе файлов, он выявляет статьи, в которых за прошедшее с предыдущего запуска время произошли изменения, а дата не поменялась, и выставляет в этих статьях новую дату.

Вот, кажется, расписал всё, что пока случилось.

Мне кажется, что с идеей парсера, который будет делать полностью правильный разбор, мы будем возиться бесконечно долго. И всё равно нужно будет придумывать какой-то механизм взаимодействия: при разборе парсер помечает какие-то статьи требующими вмешательства человека, я их анализирую и предлагаю точный вариант разметки.
Я понял, что у нас есть три задачи, над которыми можно работать. Первая: всё же начать строить базу данных и бэкенд на Python, не дожидаясь, пока мы сделаем парсер. Реализовать на питоне то же самое, что сейчас делает PHP-скрипт и Python-сервер (возможно, поднять для этого базу Postgres) и сделать бэкенд, который подменит собой нынешний old.rueo.ru, выдавая во фронт пока те же данные, которые отдаёт old.rueo.ru, то есть Ajax-подсказки и готовые полностью сформатированные в html статьи.
Вторая идея вот в чём: для полнотекстового поиска нам по сути не очень нужен полный семантический анализ словарных статей. Нам важнее развернуть сокращения и разные проблемные места.
Вот, например, в статье [am|i] вот такая словоформа:
```
[~eg/i] {vt} стр`астно, горяч`о, без`умно люб`ить; `очень люб`ить;
```
Здесь тильда заменяет часть заглавного слова статьи, стоящая до вертикальной прямой линии, то есть ~eg/i - это слово amegi (в котором, кроме прочего, слэшами показано разбиение на словообразовательные элементы). А вот дальше начинается безумие, нерешаемое автоматически никак. Через запятую могут идти синонимичные значения в переводной части, а здесь это сокращённая запись: конструкция "стр`астно, горяч`о, без`умно люб`ить" на самом деле представляет собой три словосочетания: страстно любить, горячо любить, безумно любить.
В этой же статье вот такая форма:
```
[~et/o] (люб`овное) увлеч`ение, мимолётная люб`овь;
```
содержит вариантную запись: скобки подразумевают, что это слово может использоваться, а может и не использоваться, то есть перевод для поиска должен развернуться в: увлечение, любовное увлечение, мимолётная любовь.
Иногда такие же скобки могут стоять внутри слова, тоже обозначая вариантность: скажем, слово орангутан(г) - это может быть и орангутанг, и орангутан.
(Ну и да, для полнотекстового поиска нам нужно будет удалить знаки ударения, которые в исходных текстах проставлены, что я и делал, расписывая сокращения.)
Так что по сути для полнотекстового поиска, как мне кажется, мы можем совершенно игнорировать семантическую структуру словаря, а только перенести туда весь текст статьи из исходника, соответствующим образом доработав. Поиск по полному тексту выдаст нам ссылку на статью - и мы покажем её.
И, наконец, третья часть - всё-таки полноценный парсинг. Я думаю, что мы можем в уже разработанные шаблоны добавить строгости: как только при анализе статьи обнаруживается неполное соответствие шаблону, статья помечается на проверку человеком. Может быть, даже подключить к этому процессу автономного AI-агента. Всё-таки значительная часть словаря устроена достаточно просто: слово -- перевод (или несколько синонимов). Или в той же статье несколько словоформ тоже с синонимами или без них. Результаты парсинга будут попадать в ещё одну колонку базы. После парсинга мы сможем понять, сколько процентов словаря уже анализируется правильно и сколько требует доработки.
И тут уже однозначно нужно будет создавать полноценную админку с регистрацией и с удобным выводом представления JSON в каком-то понятном мне виде. Может быть, с цветовой разметкой или ещё как-то, и с возможностью просто и ясно помечать разные странности типа тех примеров, которые я показал.
С исходными текстами мы с автором работаем в оболочке FAR в текстовом редакторе, для которого я разработал цветовую разметку, соответствующую нашей разметке скобками и прочими элементами разметки. Можешь посмотреть на скриншоте, как мы видим статью am|i. Мне было бы удобно в админке видеть исходный текст примерно в такой же расцветке (как образец) и отдельным полем выводить JSON для редактирования - но тоже не в виде JSON, а каким-то более охватываемым визуально образом.
И тут мы возвращаемся к References\updater.rueo.ru. Работа над словарём непрерывно продолжается, мы вносим в статьи правки. Поэтому по тому же принципу, по которому мы скриптом мониторим содержимое файлов русско-эсперантского словаря, нам нужно будет запоминать состояние каждой статьи и, если статья была разобрана вручную и после этого претерпела существенные изменения (не простое исправление ошибки, например), то она должна помечаться снова как требующая разбора.
