# Этап 2: Реализация полнотекстового поиска

**Цель:** Предоставить пользователям возможность поиска по всему тексту словарных статей.

### Шаг 2.1: Подготовка данных для индексации

- **2.1.1.** Создать в таблице `artikoloj` новое текстовое поле, например, `full_text_content`.
- **2.1.2.** Доработать Python-импортер (из Этапа 1), добавив в него функцию "нормализации" текста для поиска:
    - Замена тильды (`~`) на соответствующую часть заголовочного слова.
    - Раскрытие синонимов, записанных через запятую (`страстно, горячо любить` -> `страстно любить, горячо любить`).
- **2.1.3.** Добавить в импортера конвертацию сокращений и помет (например, `(любовное) увлечение` -> `любовное увлечение, увлечение`).
- **2.1.4.** Удалять ударения и специальные знаки (`'`, `` ` ``, `^`), оставляя только буквенно-цифровые символы.

### Шаг 2.2: Настройка полнотекстового индекса

- **2.2.1.** В PostgreSQL использовать `GIN`-индекс по `to_tsvector('russian', full_text_content)` и отдельный индекс для эсперанто (возможно на основе `simple` словаря).
- **2.2.2.** Настроить лексемы и поиск с учетом `ё/е`, `ĉ/cx` и т.п.
- **2.2.3.** Провести тестирование запросов и сравнить результаты со старым сайтом.

### Шаг 2.3: API для полнотекстового поиска

- **2.3.1.** Создать эндпоинт `/api/search/full-text`, принимающий поисковую строку и язык.
- **2.3.2.** Эндпоинт должен возвращать:
    - Список совпадений с кратким фрагментом (snippet).
    - Ссылку на статью (`/sercxo/{id}`).
    - Вес совпадения (релевантность).
- **2.3.3.** Предусмотреть параметры:
    - фильтр по языку (`eo`, `ru`);
    - пагинация;
    - сортировка (по релевантности или алфавиту).

### Шаг 2.4: Интеграция на фронтенде

- **2.4.1.** Добавить в `rueo_fronto` отдельную страницу (или режим), где поисковая строка выполняет полнотекстовый запрос.
- **2.4.2.** Реализовать отображение сниппетов с подсветкой совпадений.
- **2.4.3.** Добавить фильтры (по языку, типу результата).

### Шаг 2.5: Тестирование и мониторинг

- **2.5.1.** Сравнить выборку результатов со старым поиском, удостовериться в отсутствии регрессий.
- **2.5.2.** Настроить логирование полнотекстовых запросов (новая таблица или расширение `statistiko`).
- **2.5.3.** Подготовить документацию по использованию API и обновить проектную память.


### Дополнительно: корпус документов для поиска

- Помимо словаря, включаем в полнотекстовый индекс грамматический очерк: тексты сейчас в Vue-компонентах (`References/rueo_fronto/src/components/gram`); исходники в markdown/textile лежат в `References/old.rueo.ru/tekstoj/grammatika*.textile`. При расхождении источников приоритет у `.vue` (самые свежие правки).
- План: перевести грамматический корпус в Markdown (для редактирования через VS Code), использовать уже подключённый markdown-плагин на фронте, а нормализованный текст загружать в общую таблицу документов (типы: словарь, грамматика, новости и т.п.).
- Нормализацию делаем инкрементальной: после контроля checksum перерабатываем только статьи/документы, которые изменились; результаты складываем в отдельную таблицу (например, `article_texts`) и строим GIN-индексы `tsvector` по каждому языку.
- Используем полнотекстовый поиск PostgreSQL (без ElasticSearch) — достаточно для текущей нагрузки; в будущем можно рассмотреть внешний движок при необходимости.

- Перед выкладкой обновлённой версии на прод проверить отправку сообщений (Ctrl+Enter). В дев-окружении письма сейчас не приходят, на prod rueo.ru всё работает.

### Черновые заметки по парсеру v3

- `translation` складывается из узлов `content`: `label`, `text`, `divider`. Комбинация запятой и точки с запятой → `ru_requires_review` + оригинал в `meta.raw_ru_text`.
- Внутри курсивных вставок (`_или_`, `_ср._` и т.д.) не собираем пары `eo/ru`; курсив остаётся отдельным узлом.
- Иллюстрации (`illustration`) пока хранят `ru_segments`; для полнотекста надо привести их к тем же сегментам, что и `translation`.
- Скобочные варианты (`заранее (_или_ заблаговременно)`) разворачиваем и подтягиваем к ближайшему глаголу: `заранее позаботиться`, `заблаговременно позаботиться`, `предусмотреть`.
- Скобочные варианты (`заранее (_или_ заблаговременно)`) разворачиваем и подтягиваем к ближайшему глаголу: `заранее позаботиться`, `заблаговременно позаботиться`, `предусмотреть`. Для последовательностей вида `выполнить (_или_ совершить) заранее, досрочно, предварительно` строим декартовы комбинации (`выполнить досрочно`, `совершить предварительно` и т.п.).
- При повторе общего слова (например, `прежние события, прежние поступки`) на этапе нормализации формируем словосочетания целиком, чтобы в индексе лежали обе строки.
