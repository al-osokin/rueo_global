# Прогресс по Этапу 1 (16 октября 2024)

## Импорт данных

- Создан модуль `backend/app/importer.py`, реализующий перенос логики `vortaro_updater_8.php`.
- Поддерживается чтение исходных текстов из `backend/data/src` с конвертацией из cp1251 в UTF-8 и генерацией файла `tekstoj/klarigo.md`.
- Заполняются таблицы `artikoloj` и `artikoloj_ru`, формируются поисковые индексы `sercxo`, `sercxo_ru`, а также таблица `neklaraj`.
- Добавлены параметры CLI (`--data-dir`, `--no-truncate`, `--verbose`) и повторное использование для фонового запуска из админки.
- Импортёр валидирует структуру исходных файлов: ищет блоки дат без статьи и статьи без заголовка, логирует проблемы и отдаёт их в `tracking-summary`. Для сравнения статей нормализуются канонические ключи (игнорируется `|`), чтобы изменения заголовков не сбивали контрольные суммы.

## ORM и база данных

- Введён модуль `backend/app/database.py` с SQLAlchemy-движком, сессиями и `init_db()`.
- Описаны модели в `backend/app/models.py`, отражающие MySQL-схему (`artikoloj`, `sercxo`, `neklaraj`, `statistiko` и их русские аналоги).
- Реализована утилита `init_db()` для создания схемы в PostgreSQL на старте приложения.

## Поиск и форматирование

- Добавлен сервис `backend/app/services/search.py`, повторяющий поведение `sercxo.php`:
  - определение языка запроса, выдача результатов по регулярным выражениям и fallback на `LIKE`.
  - формирование HTML-верстки статьи (ссылки, пометы, значки официальных терминов, ударения, форматирование).
  - генерация «похожих слов» по таблице `neklaraj` и логирование статистики запросов в `statistiko`.
- Логика поиска дополнена точным сопоставлением вариантных форм (без/с дефисами, с кавычками, с числовыми индексами); только при отсутствии точных попаданий используется прежний `REGEXP` fallback.
- Реализован модуль `backend/app/utils/esperanto.py` для конвертаций `cx` ↔ `ĉ`, обработки `^C` и URL-вариантов.

## API FastAPI

- В `backend/app/main.py` зарегистрированы эндпоинты `/search` и `/suggest`, использующие `SearchService`.
- На событие старта подключён `init_db()`; приложение возвращает HTML-выдачу, совместимую с фронтендом.

## Администрирование

- Создан `backend/app/admin.py` с роутером `/admin`:
  - POST `/admin/import` запускает импорт в фоне, предотвращая параллельный запуск.
  - GET `/admin/import/status` возвращает состояние последнего импорта.
- Логика импорта переиспользует `run_import()` и ведёт учёт статуса (старт, окончание, ошибки).
- Реализован прогресс-репортинг: статус API теперь отражает текущий этап (обработка файлов, построение индексов, обновление нечёткого поиска) и итоговую статистику по словарям.

- Команда `python -m compileall backend/app` выполняется без ошибок (проблемы с правами на `__pycache__` устранены).

- Фронтенд перенастроен на новый бэкенд: подсказки `/suggest`, поиск `/search`, статус `/status/info`, админ-панель на `/admin/import`.
- Начали перенос контроля версий статей: добавлены таблицы `article_file_states`, `article_states`, `article_change_log`, сервис отслеживания изменений и интеграция в импортёр (с автоматическим обновлением дат).
