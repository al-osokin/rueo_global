# Документация по автоматическому обновлению кэша PWA

## Обзор реализации

Реализована система автоматического обновления кэша для PWA-приложения на Vue + Quasar, которая обеспечивает:

1. **Автоматическое обновление** при выходе новой версии
2. **Версионирование кэша** для точного управления
3. **Правильное кэширование** на стороне сервера
4. **Периодическую проверку** обновлений

## Компоненты системы

### 1. Service Worker (src-pwa/custom-service-worker.js)
- Версионирование кэша через `CACHE_VERSION`
- Автоматическая очистка старых кэшей
- Стратегии кэширования:
  - **Network-first** для API запросов
  - **Cache-first** для статических файлов

### 2. Register Service Worker (src-pwa/register-service-worker.js)
- Автоматическая перезагрузка при обновлении
- Логирование процесса обновления

### 3. Cache Manager (src/utils/cache-manager.js)
- Проверка версии через package.json
- Очистка всех кэшей при необходимости
- Интеграция с Service Worker

### 4. Конфигурация (quasar.conf.js)
- Режим InjectManifest для custom Service Worker
- Отключение автоматического кэширования Workbox

### 5. Серверная конфигурация (public/.htaccess)
- Отключение кэширования для service-worker.js
- Оптимизированное кэширование статических файлов

## Процесс обновления

1. **При запуске приложения:**
   - Проверяется версия в package.json
   - Сравнивается с текущей версией приложения
   - При несовпадении очищаются все кэши и перезагружается страница

2. **Периодическая проверка:**
   - Каждые 30 минут проверяются обновления
   - Автоматическое обновление при наличии новой версии

3. **Service Worker обновление:**
   - При обновлении Service Worker автоматически активируется
   - Старые кэши удаляются по версии

## Обновление версии

### Шаги для выпуска новой версии:

1. **Увеличить версию в package.json (в корне проекта):**
   ```json
   {
     "version": "0.1.1"
   }
   ```
   **ВАЖНО:** Версия передается в браузер через webpack define plugin. Также нужно вручную синхронизировать версию с `public/package.json`:

2. **Синхронизировать версию в public/package.json:**
   ```bash
   cp package.json public/package.json
   ```
   Или вручную обновить версию в `public/package.json`.

3. **Обновить версию в custom-service-worker.js:**
   ```javascript
   const CACHE_VERSION = 'v0.1.1';
   ```

4. **Собрать и развернуть приложение:**
   ```bash
   quasar build -m pwa
   ```

### Важно:
- **Версия должна обновляться вручную** при каждом релизе
- Увеличивайте номер версии в обоих файлах одновременно
- Используйте семантическое версионирование (MAJOR.MINOR.PATCH)
- При изменении только кэшируемого контента достаточно увеличить PATCH версию
- **Версия в основном package.json автоматически передается в браузер** через `__PACKAGE_VERSION__`

### Развертывание:
- При сборке `quasar build -m pwa` файл package.json автоматически копируется в dist/pwa/
- Убедитесь, что на сервере файл package.json доступен по пути `/package.json`
- В конфигурации веб-сервера разрешите доступ к package.json без кэширования
- **ВАЖНО:** Версии в основном package.json и public/package.json должны совпадать

## Тестирование обновлений

### Ручное тестирование:
1. Открыть приложение в браузере
2. Увеличить версию в package.json
3. Пересобрать приложение
4. Обновить страницу - должно произойти автоматическое обновление

### Проверка логов:
- Открыть DevTools → Application → Service Workers
- Проверить логи в консоли
- Убедиться в удалении старых кэшей

## Решение проблем

### Проблемы с кэшированием:
- Проверить заголовки HTTP для service-worker.js
- Убедиться в правильной версии в package.json
- Проверить консоль на наличие ошибок Service Worker

### Проблемы с обновлением:
- Очистить кэш браузера вручную
- Отменить регистрацию Service Worker в DevTools
- Перезагрузить страницу

### Непрерывные перезагрузки:
- Убедитесь, что файл package.json доступен по пути `/package.json` на сервере
- Проверьте, что веб-сервер разрешает доступ к package.json без кэширования
- В консоли браузера должны отображаться сообщения о проверке обновлений
- Система ограничивает количество проверок для предотвращения зацикливания

## Мониторинг

### Логи в консоли:
- "Загружается новая версия..." - начало обновления
- "Новая версия доступна" - завершение обновления
- "Удаляем старый кэш: ..." - очистка старых кэшей

### Метрики:
- Время обновления
- Частота обновлений
- Ошибки обновления
